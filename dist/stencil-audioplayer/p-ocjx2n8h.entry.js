import{r as t,h as e}from"./p-70644ef7.js";function i(t){const e=Math.floor(t/60),i=String(e).padStart(2,"0"),s=Math.floor(t-60*e);return`${i}:${String(s).padStart(2,"0")}`}function s(...t){return t.flatMap(t=>{if("string"==typeof t)return[t];const e=[];for(const i in t)t[i]&&e.push(i);return e}).join(" ")}class a{constructor(t){this.canvas=t,this.width=t.width,this.height=t.height,this.ctx=t.getContext("2d"),this.keyframes=[]}draw(){this.ctx.clearRect(0,0,this.width,this.width),this.drawLine();for(const t of this.keyframes)this.drawKeyframe(t);requestAnimationFrame(()=>this.draw())}handleHover(t){this.mousePos=t,null!==this.draggedId&&(this.keyframes=this.sortKeyframes(this.keyframes.map(e=>this.draggedId===e.id?Object.assign({},t,{id:e.id}):e)))}onClick(t){for(const e of this.keyframes)if(!(this.getDist(t,e)>=8))return void(this.selectedId=this.draggedId=e.id);this.addKeyframe(t)}addKeyframe(t){const e=Object.assign({},t,{id:Symbol()});this.keyframes=this.sortKeyframes([...this.keyframes,e]),this.draggedId=this.selectedId=e.id}onRelease(){this.draggedId=null}onDelete(){if(null===this.selectedId)return;const t=this.getKeyframeIndex(this.selectedId);this.keyframes=this.keyframes.filter(t=>t.id!==this.selectedId),this.selectedId=this.keyframes.length?this.keyframes[this.keyframes.length>t?t:t-1].id:null}sortKeyframes(t){return t.sort((t,e)=>t.x-e.x)}getKeyframeIndex(t){for(const[e,i]of this.keyframes.entries())if(i.id===t)return e}drawLine(){const t=this.getFullKeyframes();let e=t[0];this.ctx.strokeStyle="#aaa";for(const i of t.slice(1))this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke(),e=i}getFullKeyframes(){const t=this.keyframes[0],e=this.keyframes[this.keyframes.length-1],i=e?e.y:this.height/2;return[{x:0,y:t?t.y:this.height/2,id:Symbol("start")},...this.keyframes,{x:this.width,y:i,id:Symbol("end")}]}getSurroundingKeyframes(t){const e=this.getFullKeyframes();let i=0;for(const[s,a]of e.entries()){if(t<=a.x)break;const{x:n}=e[i];t-a.x<t-n&&(i=s)}return{prev:e[i],next:e[i+1]}}getDist(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}drawKeyframe(t){const e=this.getDist(this.mousePos,t)<8,i=t.id===this.selectedId;this.ctx.beginPath(),this.ctx.fillStyle=e?"#444":"grey",this.ctx.arc(t.x,t.y,8,0,2*Math.PI),this.ctx.fill(),this.ctx.beginPath(),this.ctx.fillStyle=i?"coral":"white",this.ctx.arc(t.x,t.y,4,0,2*Math.PI),this.ctx.fill()}}class n{constructor(e){t(this,e),this.isCollapsed=!1,this.canvasClick=t=>{this.canvas.onClick(this.getPos(t))},this.canvasRelease=()=>{this.canvas.onRelease()},this.handleHover=t=>{this.canvas.handleHover(this.getPos(t))},this.handleKeyPress=t=>{"Backspace"!==t.key&&"Delete"!==t.key||this.canvas.onDelete()},this.getPos=t=>{const{x:e,y:i}=t.target.getBoundingClientRect();return{x:~~(t.clientX-e),y:~~(t.clientY-i)}},this.collapseToggle=()=>{this.isCollapsed=!this.isCollapsed}}async getHeightPercentage(t){const e=this.canvasElement.width*t,{prev:i,next:s}=this.canvas.getSurroundingKeyframes(e);var a,n;return 1-((e-(a={min:i.x,max:s.x}).min)/(a.max-a.min)*((n={min:i.y,max:s.y}).max-n.min)+n.min)/this.canvasElement.height}componentDidLoad(){const{width:t,height:e}=this.canvasContainer.getBoundingClientRect();this.canvasElement.width=t,this.canvasElement.height=e,window.addEventListener("keydown",this.handleKeyPress),this.canvas=new a(this.canvasElement),this.canvas.draw()}render(){return e("div",{class:s("keyframe-editor",{collapsed:this.isCollapsed})},e("div",{class:s("canvas-container",{collapsed:this.isCollapsed}),ref:t=>this.canvasContainer=t},e("canvas",{ref:t=>this.canvasElement=t,onMouseDown:this.canvasClick,onMouseUp:this.canvasRelease,onMouseMove:this.handleHover})),e("div",{class:s("expand-contract-toggle",{collapsed:this.isCollapsed}),onClick:this.collapseToggle},e("span",null,"<")))}static get style(){return".keyframe-editor{--canvas-height:50px;--btn-height:10px;height:calc(var(--canvas-height) + var(--btn-height));cursor:pointer;-webkit-transition:.5s;transition:.5s}.keyframe-editor.collapsed{height:10px}.canvas-container{height:var(--canvas-height);overflow:hidden;background:#e2e2e2;-webkit-transition:.5s;transition:.5s}.canvas-container.collapsed{height:0}.expand-contract-toggle{height:var(--btn-height);background:#20212c;display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center}.expand-contract-toggle span{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;display:block;-webkit-transform:rotate(90deg) scaleX(.5);transform:rotate(90deg) scaleX(.5);-webkit-transition:.5s;transition:.5s}.expand-contract-toggle.collapsed span{-webkit-transform:rotate(90deg) scaleX(-.5);transform:rotate(90deg) scaleX(-.5)}"}}class r{constructor(e){t(this,e),this.isPlaying=!0,this.currentTime=0,this.duration=0,this.updateTime=()=>{this.currentTime=this.audioFile.currentTime},this.updateVolume=async()=>{const t=this.currentTime/this.duration,e=await this.keyframeEditor.getHeightPercentage(t);this.audioFile.volume=e},this.togglePlay=()=>{this.audioFile&&(this.audioFile[this.isPlaying?"play":"pause"](),this.isPlaying=!this.isPlaying)},this.handleTimeSeek=t=>{const e="progress-bar"===t.target.className?t.target.parentElement:t.target,{x:i,width:s}=e.getBoundingClientRect();this.audioFile.currentTime=(t.x-i)/s*this.duration},this.getTime=()=>`${i(this.currentTime)} / ${i(this.duration)}`,this.getWidth=()=>this.currentTime/this.duration*100+"%"}componentDidUpdate(){this.audioFile&&this.audioFile.src===this.url||this.initializeAudio()}initializeAudio(){this.audioFile=new Audio(this.url),this.audioFile.addEventListener("timeupdate",()=>{this.updateTime(),this.updateVolume()}),this.audioFile.addEventListener("ended",this.togglePlay),this.audioFile.addEventListener("loadeddata",()=>this.duration=this.audioFile.duration)}render(){return e("div",{class:"audioplayer"},e("div",{class:"timeline",onClick:this.handleTimeSeek},e("div",{class:"progress-bar",style:{width:this.getWidth()}})),e("div",{class:"body"},e("div",{class:"play-container"+(this.audioFile?"":" disabled")},e("div",{class:(this.isPlaying?"play":"pause")+" btn",onClick:this.togglePlay})),e("div",{class:"name"},this.name||"Unknown Song"),e("div",{class:"time"},this.getTime())),e("keyframe-editor",{ref:t=>this.keyframeEditor=t,open:!0}))}static get style(){return".audioplayer{height:50px;font-family:Arial,Helvetica,sans-serif;background:#223143;color:#fff;display:grid;grid-template-rows:auto 40px 1fr}.timeline{cursor:pointer;height:10px;background:#e2e2e2}.progress-bar{height:100%;width:0;background:coral;-webkit-transition:.5s;transition:.5s}.body{display:grid;grid-template-columns:auto 1fr auto;grid-gap:10px;-ms-flex-line-pack:center;align-content:center}.body>*{padding:5px 20px;display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center}.name{text-align:center}.btn{cursor:pointer}.play-container{width:20px}.play-container.disabled{opacity:.5}.play-container.disabled .btn{cursor:auto}.play{border:7px solid transparent;border-left:12px solid #fff;position:relative;right:-4px}.pause:after,.pause:before{content:\"\";position:absolute;width:3px;top:0;bottom:0;background:#fff}.pause{height:13px;width:11px;position:relative}.pause:before{left:0}.pause:after{right:0}"}}export{n as keyframe_editor,r as keyframed_audio_player};